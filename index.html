<!DOCTYPE html>
<html>
<head>
    <title>VHS Transfers Status</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body {
            background-color: #000;
            color: #0ff;
            font-family: 'Courier New', monospace;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #0ff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        th, td {
            padding: 12px;
            text-align: left;
            border: 1px solid #0ff;
        }

        th {
            background-color: #001f1f;
            cursor: pointer;
            position: relative;
        }

        th:hover {
            background-color: #003f3f;
        }

        th::after {
            content: '▼';
            position: absolute;
            right: 8px;
            opacity: 0.3;
        }

        th.sort-asc::after {
            content: '▼';
            opacity: 1;
        }

        th.sort-desc::after {
            content: '▲';
            opacity: 1;
        }

        tr:nth-child(even) {
            background-color: #001414;
        }

        tr:hover {
            background-color: #002828;
        }

        .title {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 0 0 10px #0ff, 0 0 20px #0ff;
            letter-spacing: 4px;
            position: relative;
        }

        .title::before {
            content: 'Oakley Tapes VHS Transfers';
            position: absolute;
            left: 2px;
            text-shadow: -1px 0 #ff0000;
            top: 0;
            color: #0ff;
            background: #000;
            overflow: hidden;
            clip: rect(0, 900px, 0, 0);
            animation: glitch-effect 3s infinite linear alternate-reverse;
        }

        @keyframes glitch-effect {
            0% {
                clip: rect(44px, 900px, 56px, 0);
            }
            20% {
                clip: rect(12px, 900px, 78px, 0);
            }
            40% {
                clip: rect(86px, 900px, 98px, 0);
            }
            60% {
                clip: rect(33px, 900px, 45px, 0);
            }
            80% {
                clip: rect(67px, 900px, 89px, 0);
            }
            100% {
                clip: rect(22px, 900px, 34px, 0);
            }
        }

        .scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(0, 255, 255, 0.1);
            animation: scanline 8s linear infinite;
            pointer-events: none;
        }

        .scanline-2 {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: rgba(0, 255, 255, 0.05);
            animation: scanline 12s linear infinite;
            pointer-events: none;
            animation-delay: 4s;
        }

        .controls {
            background: rgba(0, 31, 31, 0.5);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 255, 0.2);
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .pagination-container {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            padding: 15px;
            background: rgba(0, 31, 31, 0.5);
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        .search-box input {
            width: 200px;
        }

        .search-box input, .deck-filter select, .time-range-selector select {
            background: #001f1f;
            border: 1px solid #0ff;
            color: #0ff;
            padding: 10px 15px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .search-box input:focus, 
        .deck-filter select:focus, 
        .time-range-selector select:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
            background: #002f2f;
        }

        .pagination {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pagination button {
            background: #001f1f;
            border: 1px solid #0ff;
            color: #0ff;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: #003f3f;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #0ff;
            background: #001f1f;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
            background: #065702;
            padding: 20px;
            border-radius: 4px;
        }

        .time-range-selector {
            margin-bottom: 20px;
            text-align: center;
        }

        .time-range-selector select {
            background: #001f1f;
            border: 1px solid #0ff;
            color: #0ff;
            padding: 8px;
            cursor: pointer;
        }

        .time-range-selector select:hover {
            background: #002f2f;
        }

        .stats-section {
            background: rgba(0, 31, 31, 0.8);
            border-radius: 6px;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stats-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }

        .stats-section h3 {
            color: #0ff;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
            margin-bottom: 15px;
            letter-spacing: 1px;
        }

        .stats-data {
            line-height: 1.6;
        }

        .stats-separator {
            color: rgba(0, 255, 255, 0.5);
            margin: 0 8px;
        }
    </style>
</head>
<body>
    <div class="scanline"></div>
    <div class="scanline-2"></div>
    <div class="title">Oakley Tapes VHS Transfers</div>
    <div class="controls">
        <div class="search-box">
            <input type="text" id="search" placeholder="Search..." />
        </div>
        <div class="deck-filter">
            <select id="deckFilter">
                <option value="ALL">All Decks</option>
                <option value="VHS A">VHS A</option>
                <option value="VHS B">VHS B</option>
                <option value="VHS C">VHS C</option>
            </select>
        </div>
    </div>
    <div id="stats" class="stats"></div>
    <div id="table"></div>
    <div class="pagination-container">
        <div class="pagination">
            <button id="prevPage">Previous</button>
            <span id="pageInfo">Page 1</span>
            <button id="nextPage">Next</button>
        </div>
    </div>

    <script>
        let tableData = [];
        let filteredData = [];
        let currentSort = {
            column: 'Timestamp',
            direction: 'desc'
        };
        let currentPage = 1;
        const itemsPerPage = 50;
        let searchTerm = '';
        let selectedDeck = 'ALL';
        let selectedTimeRange = 'all-time';

        function extractTapeNumber(vhsString) {
            if (!vhsString || typeof vhsString !== 'string') return '';
            const match = vhsString.match(/^(\d+)/);
            return match ? match[1] : '';
        }

        function parseVHSDate(label) {
            if (!label) return null;
            
            // Match patterns like "97 May 15" or "95 Dec 07" or "97 Aug 08-10"
            const match = label.match(/(\d{2})\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+(\d{1,2}(?:-\d{1,2})?)/i);
            
            if (match) {
                const year = parseInt('19' + match[1]); // Convert '97' to 1997
                const month = {
                    'jan': 0, 'feb': 1, 'mar': 2, 'apr': 3, 'may': 4, 'jun': 5,
                    'jul': 6, 'aug': 7, 'sep': 8, 'oct': 9, 'nov': 10, 'dec': 11
                }[match[2].toLowerCase()];
                const day = parseInt(match[3].split('-')[0]); // Take first day if range
                
                return new Date(year, month, day);
            }
            return null;
        }

        function isWithinTimeRange(timestamp, range) {
            if (!timestamp) return false;
            const now = new Date();
            const tapeTime = new Date(timestamp);
            const diffHours = (now - tapeTime) / (1000 * 60 * 60);
            
            switch(range) {
                case '24h': return diffHours <= 24;
                case '48h': return diffHours <= 48;
                case 'week': return diffHours <= 168; // 7 * 24
                case 'month': return diffHours <= 720; // 30 * 24
                case 'year': return diffHours <= 8760; // 365 * 24
                default: return true; // all-time
            }
        }

        function formatData(data) {
            return data
                .filter(row => row && row.VHS)
                .map(row => {
                    const label = row.VHS ? row.VHS.split(' ').slice(1).join(' ').replace('.mp4', '') : '';
                    const tapeDate = parseVHSDate(label);
                    
                    // Format the date nicely
                    const formattedDate = tapeDate ? new Intl.DateTimeFormat('en-US', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    }).format(tapeDate) : '';
                    
                    return {
                        Deck: row.Deck || '',
                        'Tape #': extractTapeNumber(row.VHS),
                        Label: label,
                        'Tape Date': formattedDate,
                        Timestamp: row.Timestamp || '',
                        Note: row.Note || '',
                        _tapeDate: tapeDate // Keep hidden field for sorting
                    };
                });
        }

        function filterData() {
            let filtered = [...tableData];
            
            // Apply search filter
            if (searchTerm) {
                filtered = filtered.filter(row => 
                    Object.values(row).some(value => 
                        value.toString().toLowerCase().includes(searchTerm.toLowerCase())
                    )
                );
            }

            // Apply deck filter
            if (selectedDeck !== 'ALL') {
                filtered = filtered.filter(row => row.Deck === selectedDeck);
            }

            // Apply sorting
            filtered.sort((a, b) => {
                let valueA = a[currentSort.column];
                let valueB = b[currentSort.column];

                if (currentSort.column === 'Tape #') {
                    valueA = parseInt(valueA) || 0;
                    valueB = parseInt(valueB) || 0;
                } else if (currentSort.column === 'Tape Date') {
                    // Use the hidden _tapeDate field for sorting
                    valueA = a._tapeDate ? a._tapeDate.getTime() : 0;
                    valueB = b._tapeDate ? b._tapeDate.getTime() : 0;
                }

                return currentSort.direction === 'desc' 
                    ? (valueA < valueB ? 1 : -1)
                    : (valueA > valueB ? 1 : -1);
            });

            return filtered;
        }

        function updateStats() {
            const stats = document.getElementById('stats');
            
            // Filter data by time range
            const timeFilteredData = tableData.filter(row => 
                isWithinTimeRange(row.Timestamp, selectedTimeRange)
            );
            
            const totalTapes = timeFilteredData.length;
            
            // Update all the counting logic to use timeFilteredData instead of tableData
            const deckCounts = timeFilteredData.reduce((acc, row) => {
                acc[row.Deck] = (acc[row.Deck] || 0) + 1;
                return acc;
            }, {});

            const yearCounts = timeFilteredData.reduce((acc, row) => {
                if (row._tapeDate) {
                    const year = row._tapeDate.getFullYear();
                    acc[year] = (acc[year] || 0) + 1;
                }
                return acc;
            }, {});

            const monthYearCounts = timeFilteredData.reduce((acc, row) => {
                if (row._tapeDate) {
                    const year = row._tapeDate.getFullYear();
                    const month = row._tapeDate.getMonth();
                    const key = `${year}-${(month + 1).toString().padStart(2, '0')}`;
                    acc[key] = (acc[key] || 0) + 1;
                }
                return acc;
            }, {});

            // Rest of the date calculations using timeFilteredData...
            const dates = timeFilteredData
                .map(row => row._tapeDate)
                .filter(date => date !== null);
            
            const earliestDate = dates.length ? new Date(Math.min(...dates)) : null;
            const latestDate = dates.length ? new Date(Math.max(...dates)) : null;

            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Add the time range selector above the stats grid
            let statsHTML = `
                <div class="time-range-selector">
                    <select id="timeRange">
                        <option value="all-time" ${selectedTimeRange === 'all-time' ? 'selected' : ''}>All Time</option>
                        <option value="24h" ${selectedTimeRange === '24h' ? 'selected' : ''}>Past 24 Hours</option>
                        <option value="48h" ${selectedTimeRange === '48h' ? 'selected' : ''}>Past 48 Hours</option>
                        <option value="week" ${selectedTimeRange === 'week' ? 'selected' : ''}>Past Week</option>
                        <option value="month" ${selectedTimeRange === 'month' ? 'selected' : ''}>Past Month</option>
                        <option value="year" ${selectedTimeRange === 'year' ? 'selected' : ''}>Past Year</option>
                    </select>
                </div>
                <div class="stats-grid">
                    <div class="stats-section">
                        <h3>Collection Overview</h3>
                        <div class="stats-data">
                            <strong>Total Tapes:</strong> ${totalTapes}<br>
                            <strong></strong> 
                            VHS A: ${deckCounts['VHS A'] || 0}<br>
                            VHS B: ${deckCounts['VHS B'] || 0}<br>
                            VHS C: ${deckCounts['VHS C'] || 0}
                        </div>
                    </div>

                    <div class="stats-section">
                        <h3>Date Coverage</h3>
                        <div class="stats-data">
                            ${earliestDate ? 
                                `${monthNames[earliestDate.getMonth()]} ${earliestDate.getFullYear()} 
                                <span class="stats-separator">→</span>
                                ${monthNames[latestDate.getMonth()]} ${latestDate.getFullYear()}` : 
                                'No dates available'}
                        </div>
                    </div>

                    <div class="stats-section">
                        <h3>Tapes by Year</h3>
                        <div class="stats-data">
                            ${Object.entries(yearCounts)
                                .sort(([a], [b]) => a - b)
                                .map(([year, count]) => `${year}: ${count}`)
                                .join(' <span class="stats-separator">|</span> ')}
                        </div>
                    </div>

                    <div class="stats-section">
                        <h3>Monthly Distribution</h3>
                        <div class="stats-data">
                            ${Object.entries(monthYearCounts)
                                .sort(([a], [b]) => a.localeCompare(b))
                                .map(([yearMonth, count]) => {
                                    const [year, month] = yearMonth.split('-');
                                    return `${monthNames[parseInt(month) - 1]} ${year}: ${count}`;
                                })
                                .join(' <span class="stats-separator">|</span> ')}
                        </div>
                    </div>
                </div>
            `;

            stats.innerHTML = statsHTML;
            
            // Add event listener for the new time range selector
            document.getElementById('timeRange').addEventListener('change', (e) => {
                selectedTimeRange = e.target.value;
                updateStats();
            });
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
        }

        function renderTable(data) {
            // Calculate pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedData = data.slice(startIndex, startIndex + itemsPerPage);

            // Create table
            const table = document.createElement('table');
            const headers = Object.keys(data[0]).filter(header => !header.startsWith('_')); // Filter out hidden fields
            const thead = table.createTHead();
            const headerRow = thead.insertRow();

            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                if (currentSort.column === header) {
                    th.classList.add(`sort-${currentSort.direction}`);
                }
                th.onclick = () => {
                    currentSort.direction = currentSort.column === header && 
                        currentSort.direction === 'asc' ? 'desc' : 'asc';
                    currentSort.column = header;
                    updateDisplay();
                };
                headerRow.appendChild(th);
            });

            renderTableBody(paginatedData, table, headers);
            const tableContainer = document.getElementById('table');
            tableContainer.innerHTML = '';
            tableContainer.appendChild(table);
        }

        function renderTableBody(data, table, headers) {
            if (table.tBodies.length > 0) {
                table.removeChild(table.tBodies[0]);
            }
            
            const tbody = table.createTBody();
            data.forEach(row => {
                const tr = tbody.insertRow();
                headers.forEach(header => {
                    const td = tr.insertCell();
                    td.textContent = row[header] || '';
                });
            });
        }

        function updateDisplay() {
            filteredData = filterData();
            renderTable(filteredData);
            updatePagination();
            updateStats();
        }

        function initializeEventListeners() {
            document.getElementById('search').addEventListener('input', (e) => {
                searchTerm = e.target.value;
                currentPage = 1;
                updateDisplay();
            });

            document.getElementById('deckFilter').addEventListener('change', (e) => {
                selectedDeck = e.target.value;
                currentPage = 1;
                updateDisplay();
            });

            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    updateDisplay();
                }
            });

            document.getElementById('nextPage').addEventListener('click', () => {
                if (currentPage * itemsPerPage < filteredData.length) {
                    currentPage++;
                    updateDisplay();
                }
            });
        }

        function updateTable() {
            Papa.parse('vhs_transfers.csv', {
                download: true,
                header: true,
                complete: function(results) {
                    tableData = formatData(results.data);
                    updateDisplay();
                }
            });
        }

        initializeEventListeners();
        updateTable();
        setInterval(updateTable, 300000);
    </script>
</body>
</html>